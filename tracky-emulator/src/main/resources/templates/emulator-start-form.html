<!DOCTYPE html>
<html xmlns:th="http://www.thymeleaf.org">
<head>
    <meta charset="UTF-8">
    <title>ì—ë®¬ë ˆì´í„° ì‹œë™ ì„¤ì •</title>
    <script>
        function disableButton(buttonId) {
            const button = document.getElementById(buttonId);
            button.disabled = true;
            button.textContent += " (ìš”ì²­ ì¤‘)";
        }

        function validateSelection() {
            const selected = document.querySelectorAll("input[name='selectedMdns']:checked").length;
            if (selected === 0) {
                alert("âš ï¸ ìµœì†Œ í•œ ê°œ ì´ìƒì˜ í•­ëª©ì„ ì„ íƒí•´ì£¼ì„¸ìš”.");
                return false;
            }
            return true;
        }

        function selectAll() {
            document.querySelectorAll("input[name='selectedMdns']").forEach(cb => cb.checked = true);
            updateSelectedCount();
        }

        function deselectAll() {
            document.querySelectorAll("input[name='selectedMdns']").forEach(cb => cb.checked = false);
            updateSelectedCount();
        }

        function updateSelectedCount() {
            const count = document.querySelectorAll("input[name='selectedMdns']:checked").length;
            document.getElementById("selected-count").textContent = count;
        }

        function validateSelectionAndHide() {
            const selected = document.querySelectorAll("input[name='selectedMdns']:checked").length;
            if (selected === 0) {
                alert("âš ï¸ ìµœì†Œ í•œ ê°œ ì´ìƒì˜ í•­ëª©ì„ ì„ íƒí•´ì£¼ì„¸ìš”.");
                return false;
            }

            // ì„ íƒë˜ë©´ ë¦¬ìŠ¤íŠ¸ ì˜ì—­ ìˆ¨ê¹€
            const listDiv = document.getElementById("available-list-container");
            if (listDiv) {
                listDiv.style.display = "none";
            }

            return true;
        }

        document.addEventListener("DOMContentLoaded", () => {
            document.querySelectorAll("input[name='selectedMdns']").forEach(cb => {
                cb.addEventListener("change", updateSelectedCount);
            });
        });
    </script>
</head>
<body>
<h2>ì—ë®¬ë ˆì´í„° ì‹œë™ ì„¤ì •</h2>

<!-- âœ… ìƒì„± ê°€ëŠ¥í•œ mdn/bizId í™•ì¸ ìš”ì²­ -->
<form th:action="@{/emulator/available}" method="post">
    <h3> 1. í˜„ì¬ ìƒì„± ê°€ëŠ¥í•œ ì—ë®¬ë ˆì´í„° í™•ì¸
        <button type="submit">âœ… í´ë¦­</button>
    </h3>
</form>

<hr/>

<!-- âœ… availableList ë³´ì—¬ì£¼ê³  ì‚¬ìš©ìì—ê²Œ ì„ íƒ ë°›ê¸° -->
<div id="available-list-container">
    <h3>2. í˜„ì¬ ìƒì„± ê°€ëŠ¥í•œ ì°¨ëŸ‰ê´€ë¦¬(MDN) ë¦¬ìŠ¤íŠ¸
        <button type="button" onclick="selectAll()">ì „ì²´ ì„ íƒ</button>
        <button type="button" onclick="deselectAll()">ì „ì²´ í•´ì œ</button>
    </h3>
    <form th:if="${availableMdnAndBizId}" th:action="@{/emulator/configure-selected}" method="post"
          onsubmit="return validateSelectionAndHide()">
        <p>âœ” ì„ íƒëœ í•­ëª© ìˆ˜: <span id="selected-count">0</span></p>

        <ul>
            <li th:each="item : ${availableMdnAndBizId}">
                <label>
                    <input type="checkbox" name="selectedMdns" th:value="${item.mdn}"/>
                    <span th:text="${item.mdn}"></span> (BizId: <span th:text="${item.bizId}"></span>)
                </label>
            </li>
        </ul>
        <button type="submit"> ì—ë®¬ë ˆì´í„° ìƒì„±</button>
    </form>
</div>

<!-- âœ… ìƒì„±ëœ ì¸ìŠ¤í„´ìŠ¤ ìˆ˜ í‘œì‹œ -->
<div>
    <h4>ğŸ“Œ í˜„ì¬ ìƒì„±ëœ ì—ë®¬ë ˆì´í„° ê°œìˆ˜: </strong> <span th:text="${instanceCount ?: 'ì„¤ì •ë˜ì§€ ì•ŠìŒ'}"></span></h4>
</div>

<hr/>

<!-- âœ… í† í° ìš”ì²­ -->
<form th:action="@{/emulator/fetch-token}" method="post">
    <h3> 3. í† í° ì •ë³´ ë°›ì•„ì˜¤ê¸°
        <button type="submit">âœ… í´ë¦­</button>
    </h3>
</form>
<!-- âœ… í† í° ê²°ê³¼ -->
<div th:if="${tokenResults}">
    <h4>ğŸ” í† í° ìš”ì²­ ê²°ê³¼</h4>
    <ul>
        <li th:each="entry : ${tokenResults}">
            <span th:text="${entry.key}"></span> ì°¨ëŸ‰ :
            <span th:text=" ${entry.value}"></span>
        </li>
    </ul>
</div>

<hr/>

<!-- âœ… ì‹œë™ ON -->
<form th:action="@{/emulator/start}" method="post" onsubmit="disableButton('start-btn')">
    <h3> 4. ì‹œë™ ON ìš”ì²­
        <button type="submit" id="start-btn" th:disabled="${engineStatus == 'ON'}"> âœ… í´ë¦­</button>
    </h3>

</form>

<!-- âœ… SSE ì£¼ê¸° ë¡œê·¸ -->
<div id="log">
    <h5> &nbsp; ğŸš— ì£¼ê¸° ë°ì´í„° ì „ì†¡ ë‚´ì—­ ğŸš—</h5>
</div>

<script>
    const eventSource = new EventSource('/emulator/stream');

    eventSource.addEventListener("cycleLog", function (event) {
        const data = JSON.parse(event.data);
        const logContainer = document.getElementById('log');
        const newLog = document.createElement('div');
        newLog.textContent = `${data.mdn} â†’ ${data.lat}, ${data.lon}, ${data.spd}km/h`;
        logContainer.appendChild(newLog);
    });

    eventSource.onerror = function (error) {
        console.error("ğŸš¨ SSE ì—°ê²° ì˜¤ë¥˜:", error);
    };
</script>

<hr/>
<!-- âœ… ì‹œë™ OFF -->
<form th:action="@{/emulator/stop}" method="post" onsubmit="disableButton('stop-btn')">
    <h3>
        5. ì‹œë™ OFF ìš”ì²­
        <button type="submit" id="stop-btn" th:disabled="${engineStatus == null}"> âœ… í´ë¦­</button>
    </h3>
</form>

<!-- âœ… ë©”ì‹œì§€ ì¶œë ¥ -->
<p th:if="${message}" th:text="${message}">ê²°ê³¼</p>


<hr/>


<!-- âœ… ì„¸ì…˜ ì´ˆê¸°í™” -->
<br/>
<form th:action="@{/emulator/reset}" method="post">
    <button type="submit">ğŸ§¹ ì„¸ì…˜ ì •ë³´ ì´ˆê¸°í™”</button>
</form>

</body>
</html>
