<!DOCTYPE html>
<html xmlns:th="http://www.thymeleaf.org">
<head>
    <meta charset="UTF-8">
    <title>ì—ë®¬ë ˆì´í„° ì‹œë™ ì„¤ì •</title>
    <script>
        function validateEmulatorCount(event) {
            const count = parseInt(document.getElementById("emulator-count").value);
            if (isNaN(count) || count < 1 || count > 15000) {
                alert("âš ï¸ ì—ë®¬ë ˆì´í„° ê°œìˆ˜ëŠ” 1 ì´ìƒ 15000 ì´í•˜ë¡œ ì…ë ¥í•´ì•¼ í•©ë‹ˆë‹¤.");
                event.preventDefault();
                return false;
            }
            return true;
        }

        function disableButton(buttonId) {
            const button = document.getElementById(buttonId);
            button.disabled = true;
            button.textContent += " (ìš”ì²­ ì¤‘)";
        }
    </script>
</head>
<body>
<h2>ì—ë®¬ë ˆì´í„° ìˆ˜ë™ ì‹œë™ ì„¤ì •</h2>

<br/>
<form th:action="@{/emulator/available}" method="post">
    <button type="submit">âœ… í˜„ì¬ ìƒì„± ê°€ëŠ¥í•œ ì—ë®¬ë ˆì´í„° ê°œìˆ˜ í™•ì¸</button>
</form>

<p th:if="${availableCount != null}">
    <strong>ğŸ“Œ í˜„ì¬ ìƒì„± ê°€ëŠ¥ ì—ë®¬ë ˆì´í„° ê°œìˆ˜ : </strong> <span th:text="${availableCount}"></span> ëŒ€
</p>

<!-- âœ… ìƒíƒœ ì •ë³´ -->
<div>
    <p><strong>ğŸ“Œ í˜„ì¬ ìƒì„±ëœ ì—ë®¬ë ˆì´í„° ê°œìˆ˜: </strong> <span th:text="${instanceCount ?: 'ì„¤ì •ë˜ì§€ ì•ŠìŒ'}"></span></p>

</div>

<hr/>

<form th:action="@{/emulator/configure}" method="post" onsubmit="return validateEmulatorCount(event)">
    <label>ì—ë®¬ë ˆì´í„° ê°œìˆ˜:
        <input type="number" id="emulator-count" name="count" min="1" max="15000" value="1"/>
    </label>
    <button type="submit">ì—ë®¬ë ˆì´í„° ê°œìˆ˜ ì„¤ì •</button>
</form>

<br/>
<form th:action="@{/emulator/fetch-token}" method="post">
    <button type="submit">í† í° ë° ì´ˆê¸° ì •ë³´ ë°›ì•„ì˜¤ê¸°</button>
</form>

<br/>
<form th:action="@{/emulator/start}" method="post" onsubmit="disableButton('start-btn')">
    <button type="submit" id="start-btn" th:disabled="${engineStatus == 'ON'}">ğŸš— ì‹œë™ ON ìš”ì²­</button>
</form>

<br/>
<form th:action="@{/emulator/stop}" method="post" onsubmit="disableButton('stop-btn')">
    <button type="submit" id="stop-btn"
            th:disabled="${engineStatus == null}">
        ğŸ›‘ ì‹œë™ OFF ìš”ì²­
    </button></form>

<p th:if="${message}" th:text="${message}">ê²°ê³¼ ë©”ì‹œì§€</p>

<!-- âœ… í† í° ìš”ì²­ ê²°ê³¼ í‘œì‹œ -->
<div th:if="${tokenResults}">
    <h3>í† í° ìš”ì²­ ê²°ê³¼</h3>
    <ul>
        <li th:each="entry : ${tokenResults}">
            <span th:text="${entry.key}"></span> â†’
            <span th:text="${entry.value}"></span>
        </li>
    </ul>
</div>

<hr/>

<!-- âœ… ì£¼ê¸° ë°ì´í„° ì „ì†¡ ë¡œê·¸ í‘œì‹œ -->
<div id="log">
    <h3>ğŸš— ì£¼ê¸° ë°ì´í„° ì „ì†¡ ë‚´ì—­</h3>
</div>

<script>
    const eventSource = new EventSource('/emulator/stream');

    eventSource.addEventListener("cycleLog", function (event) {
        const data = JSON.parse(event.data);
        const logContainer = document.getElementById('log');
        const newLog = document.createElement('div');
        newLog.textContent = `${data.mdn} â†’ ${data.lat}, ${data.lon}, ${data.spd}km/h`;
        logContainer.appendChild(newLog);
    });

    eventSource.onerror = function (error) {
        console.error("ğŸš¨ SSE ì—°ê²° ì˜¤ë¥˜:", error);
    };
</script>

<br/>
<form th:action="@{/emulator/reset}" method="post">
    <button type="submit">ğŸ§¹ ì„¸ì…˜ ì •ë³´ ì´ˆê¸°í™”</button>
</form>

</body>
